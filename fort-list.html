<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="fort-li.html">
<link rel="import" href="fort-list-group.html">
<link rel="import" href="../fort-theme/fort-theme-style.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../fort-behavior/fort-iterator-behavior.html">

<!--
A List

Example:

    <forti-list></fort-list>

@demo demo/index.html
-->

<dom-module id="fort-list"
            attributes="zebra border double-border border-group show-filter filter-label filter-icon autofocus no-results-content">
  <template>
    <style>
      :host {
        display: block;
        --fort-list-border-color: var(--divider-secondary-color, rgba(0, 0, 0, 0.06));
        --fort-list-double-border-color: var(--divider-primary-color, rgba(0, 0, 0, 0.12));
        @apply --fort-list-style;
      }

      :host([zebra]) ::content fort-li[odd] {
        background-color: var(--theme-300-color, #F0F6FA);
      }

      :host([border]) ::content fort-li,
      :host([double-border]) ::content fort-li {
        border-bottom: 1px solid var(--fort-list-border-color);
      }

      :host([border]) ::content fort-li:last-child,
      :host([double-border]) ::content fort-li:last-child {
        border-bottom: 0;
      }

      :host([double-border]) ::content fort-li {
        border-top: 1px solid var(--fort-list-double-border-color);
      }

      :host([double-border]) ::content fort-li:first-of-type {
        border-top: 0;
      }

      :host [prefix] {
        margin-left: 16px;
        margin-right: 32px;
      }

      :host([show-filter]) .filter {
        display: block;
      }

      :host .filter {
        display: none;
        @apply --text-secondary;
        @apply --paper-font-body2;
        @apply --fort-list-filter;
      }

      :host .items {
        @apply --fort-list-items-container;
      }

      :host {
        --paper-input-container: {
          line-height: 48px;
          padding: 0;
        };
        --paper-input-container-label: {
          line-height: 48px;
          padding: 0;
        };
        --paper-input-container-input: {
          line-height: 48px;
          padding: 0;
        };
      }

      :host .no-results {
        display: none;
      }

      :host([no-results]) .no-results {
        display: block;
      }

      :host .filter-value {

      }
    </style>

    <div class="filter">
      <paper-input autofocus$="[[autofocus]]" id="filterInput" label="{{filterLabel}}" no-label-float
                   value="{{filterValue}}">
        <iron-icon icon="{{filterIcon}}" prefix></iron-icon>
      </paper-input>
    </div>
    <div class="items">
      <div class="no-results">
        <paper-icon-item>
          {{noResultsContent}}&nbsp;<q class="filter-value">{{filterValue}}</q>
        </paper-icon-item>
      </div>
      <content select="fort-li,fort-list-group"></content>
    </div>
  </template>

  <script>
    Polymer(
      {
        is:          'fort-list',
        properties:  {
          filterValue:      {
            type:     String,
            notify:   true,
            observer: '_filterList'
          },
          showFilter:       {
            type:               Boolean,
            reflectToAttribute: true,
            value:              false
          },
          filterLabel:      {
            type:  String,
            value: "Filter"
          },
          filterIcon:       {
            type:  String,
            value: "icons:filter-list"
          },
          zebra:            {
            type:  Boolean,
            value: false
          },
          border:           {
            type:  Boolean,
            value: false
          },
          doubleBorder:     {
            type:  Boolean,
            value: false
          },
          noResults:        {
            type:               Boolean,
            value:              false,
            reflectToAttribute: true
          },
          noResultsContent: {
            type:  String,
            value: "No Results Matching "
          }
        },
        ready:       function ()
                     {
                       var self = this;
                       this.iterate(
                         this.querySelectorAll('fort-li'),
                         function (e)
                         {
                           e.addEventListener(
                             'fort-li-filtered', function ()
                             {
                               self.noResults = self.querySelectorAll('fort-li:not([hidden])').length == 0;
                             }
                           );
                         }
                       );
                     },
        focus:       function ()
                     {
                       this.$.filterInput.focus();
                     },
        _filterList: function (filterValue)
                     {
                       var visibleCount
                         = this._doFilter(filterValue, this.queryAllEffectiveChildren('fort-li,fort-list-group'), this);
                       this.noResults = visibleCount == 0;
                     },
        _doFilter:   function (filterValue, items, parentNode)
                     {
                       var self = this, visibleCount = 0;
                       this.iterate(
                         items, function (item)
                         {
                           if(item.tagName == 'FORT-LIST-GROUP')
                           {
                             var vc = self._doFilter(
                               filterValue,
                               item.queryAllEffectiveChildren
                                 ? item.queryAllEffectiveChildren('fort-li') : item.children,
                               item
                             );
                             item.shown = vc > 0;
                             visibleCount += vc;
                           }
                           else if(item.tagName == 'FORT-LI')
                           {
                             item.hidden = filterValue != ""
                               && (item.getEffectiveTextContent()
                                       .toLowerCase()
                                       .indexOf(filterValue.toLowerCase()) == -1);

                             var idx = Array.prototype.indexOf.call(
                               parentNode.querySelectorAll('fort-li:not([hidden])'),
                               item
                             );
                             item.odd = idx > -1 && (idx % 2 == 0);

                             visibleCount += item.hidden ? 0 : 1;
                           }
                         }
                       );
                       return visibleCount;
                     },

        behaviors: [Polymer.FortIteratorBehavior]
      }
    );
  </script>
</dom-module>
