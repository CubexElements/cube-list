<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="fort-li.html">
<link rel="import" href="fort-list-group.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../fort-icon/fort-icon.html">
<link rel="import" href="../fort-behavior/fort-iterator-behavior.html">

<!--
A List

Example:

    <forti-list></fort-list>

@demo demo/index.html
-->

<dom-module id="fort-list"
            attributes="zebra border double-border show-filter filter-label filter-icon autofocus no-results-content custom">
  <template>
    <style>
      :host {
        display: block;

        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Chrome/Safari/Opera */
        -khtml-user-select: none; /* Konqueror */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently not supported by any browser */

        @apply --fort-list-style;

        --paper-input-container: {
          line-height: 48px;
        };
        --paper-input-container-label: {
          line-height: 48px;
          padding: 0;
        };
        --paper-input-container-input: {
          line-height: 48px;
          padding: 0;
        };
      }

      :host [prefix] {
        margin-left: 16px;
        margin-right: 32px;
      }

      :host([show-filter]) .filter {
        display: block;
      }

      :host .filter {
        display: none;
        @apply --text-secondary;
        @apply --paper-font-body2;
        @apply --fort-list-filter;
      }

      :host #filterInput {
        --paper-input-container: {
          line-height: normal;
        };
      }

      :host #filterInput > fort-icon {
        width: var(--paper-item-icon-width, 56px);
        padding: 0;
        color: var(--text-color);
      }

      :host > #itemsContainer {
        @apply --fort-list-items-container;
      }
    </style>

    <div class="filter">
      <paper-input id="filterInput" autofocus$="[[autofocus]]" label="[[filterLabel]]" no-label-float
                   value="{{filterValue}}">
        <fort-icon icon="[[filterIcon]]" slot="prefix"></fort-icon>
      </paper-input>
    </div>
    <div id="itemsContainer">
      <div hidden="[[!noResults]]">
        <paper-icon-item>
          [[noResultsContent]]&nbsp;<q class="filter-value">[[filterValue]]</q>
        </paper-icon-item>
      </div>
      <div id="itemsContentContainer">
        <slot id="items"></slot>
      </div>
    </div>
  </template>

  <script>
    Polymer(
      {
        is:         'fort-list',
        properties: {
          filterValue:      {
            type:     String,
            notify:   true,
            observer: '_debounceFilter'
          },
          showFilter:       {
            type:               Boolean,
            reflectToAttribute: true,
            value:              false
          },
          filterLabel:      {
            type:  String,
            value: "Filter"
          },
          filterIcon:       {
            type:  String,
            value: "icons:filter-list"
          },
          zebra:            {
            type:  Boolean,
            value: false
          },
          border:           {
            type:  Boolean,
            value: false
          },
          doubleBorder:     {
            type:  Boolean,
            value: false
          },
          custom:           {
            type:               Boolean,
            value:              false,
            reflectToAttribute: true
          },
          noResults:        {type: Boolean, value: false},
          noResultsContent: {type: String, value: "No Results Matching"}
        },

        listeners:       {'dom-change': '_debounceFilter'},
        _debounceFilter: function ()
                         {
                           this.debounce('dom-changed', this._filterList, 50);
                         },

        attached:    function ()
                     {
                       Polymer.RenderStatus.afterNextRender(this, this._debounceFilter);
                       this.$.filterInput.addEventListener(
                         'keydown', function (e) { e.stopPropagation(); }
                       )
                     },
        focus:       function ()
                     {
                       this.$.filterInput.focus();
                     },
        _filterList: function ()
                     {
                       var
                         filterValue = this.filterValue || '',
                         visibleCount = this._doFilter(filterValue, this.$.items.assignedNodes({flatten: true}));
                       this.noResults = filterValue && this.showFilter && visibleCount == 0;
                     },
        _doFilter:   function (filterValue, items)
                     {
                       var self = this, visibleCount = 0;
                       this.iterate(
                         items, function (item)
                         {
                           if(item.tagName == 'FORT-LIST-GROUP')
                           {
                             var vc = self._doFilter(filterValue, item.children);
                             item.hidden = vc <= 0;
                             visibleCount += vc;
                           }
                           else if(item.tagName == 'FORT-LI')
                           {
                             item.hidden = filterValue
                               && (item.textContent.toLowerCase().indexOf(filterValue.toLowerCase()) == -1);
                             visibleCount += item.hidden ? 0 : 1;
                           }
                         }
                       );
                       this.iterate(
                         items, function (item)
                         {
                           if(item.tagName == 'FORT-LI')
                           {
                             var all = item.parentNode.querySelectorAll(':scope > fort-li:not([hidden])');
                             var idx = Array.prototype.indexOf.call(all, item);
                             item.odd = self.zebra && idx > -1 && (idx % 2 == 0);
                             item.firstItem = idx == 0;
                             item.lastItem = idx == all.length - 1;
                           }
                         }
                       );
                       return visibleCount;
                     },

        behaviors: [Polymer.FortIteratorBehavior]
      }
    );
  </script>
</dom-module>
